<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Song Viewer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
  body {
    background-color: #000;
    color: #fff;
    font-family: 'Courier New', monospace;
  }

  .song-list, .queue {
    background-color: #222;
    height: 100vh;
    overflow-y: auto;
    padding: 10px;
    font-size: 0.85rem;
  }

  .song-link {
    text-decoration: none;
    color: #ccc;
    display: block;
    padding: 2px 0;
    transition: color 0.2s ease;
  }

  .song-link:hover {
    color: #fff;
  }

  .video-section {
    background-color: #111;
    padding: 10px;
  }

  .sheet-section {
    background-color: #000;
    padding: 10px;
    text-align: center;
  }

  img.sheet {
    max-width: 100%;
    height: auto;
    border: 1px solid #444;
  }

.player-buttons {
  position: sticky;
  bottom: 0;
  background-color: #111; /* Match theme */
  padding: 10px;
}


  select.form-select {
    background-color: #333;
    color: #fff;
    border: 1px solid #444;
    font-size: 0.85rem;
    font-family: 'Courier New', monospace;
  }

  h6 {
    font-size: 0.9rem;
    margin-top: 10px;
    font-weight: bold;
  }
</style>

</head>
<body>
  <div class="container-fluid">
    <div class="row">
     <!-- Column 1: Genre & Song List -->
       <div class="col-3 song-list">
        <form method="get" onchange="this.submit()">
          <label for="genreSelect">Genre</label>
           <select id="genreSelect" name="genre" class="form-select form-select-sm mb-2">
           {% for g in genres %}
            <option value="{{ g }}" {% if g == genre %}selected{% endif %}>{{ g }}</option>
           {% endfor %}
           </select>
        </form>

<!--      <h6>Songs in "{{ genre }}"</h6>-->
      <ul class="list-unstyled">
        {% for song in songs %}
        {% set name = song.rsplit('.', 1)[0] %}
          <li class="song-link text-white" style="cursor: pointer;" onclick='addToQueue({{ genre|tojson }}, {{ song|tojson }})'>
             {{ song.rsplit('.', 1)[0] }}
          </li>
        {% else %}
        <li class="text-muted">No songs found.</li>
        {% endfor %}
      </ul>
    </div>

<!-- Column 2: Video and Queue -->
    <div class="col-4 video-section">
<!-- ##### VIDEO SCREEN #### -->
      <video id="video-player" controls width="100%">
        <source id="video-source" src="" type="video/mp4">
           Your browser does not support the video tag.
      </video>

<!-- #### QUEUE #### -->
       <div class="queue mt-3">
         <!--<h6>Queue</h6>-->
        <div class="queue overflow-auto" style="flex-grow: 1; max-height: 200px;">
         <ul class="list-unstyled">
           {% for q in queue %}
             <li class="text-white song-link" style="font-size: 0.85rem;" onclick='removeFromQueue({{ q|tojson }})'>
                {{ q.rsplit('.', 1)[0] }}
             </li>
           {% endfor %}
         </ul>
        </div>
<!--      -->

 <!-- #### PLAYER BUTTONS #### -->
       <div class="mt-2 text-center border-top pt-2">
           <button class="btn btn-warning btn-sm" onclick="PreviousSong()">Previous</button>
<!--            <button onclick="playSong()">‚ñ∂ Play / ‚ùö‚ùö Pause</button>-->
            <button onclick="playSong('{{ genre }}', '{{ current_song[:-4] if current_song }}')">‚ñ∂ Play</button>
            <button class="btn btn-success btn-sm" onclick="stopPlayback()">‚èπ Stop</button>
            <button class="btn btn-warning btn-sm" onclick="restartSong()">üîÅ Start Over</button>
           <button class="btn btn-warning btn-sm" onclick="nextSong()">Next</button>
           <button class="btn btn-danger btn-sm mt-2" onclick="clearQueue()">üßπ Clear Queue</button>
        </div>
       </div>
      </div>
<!-- Columns 3: Song Sheet -->
      <div class="col-5 sheet-section">
<!--        <h6>Song Sheet</h6>-->
        <img src="{{ url_for('static', filename='Chill/song.png') }}" id="sheet-display" alt="Song Sheet">
        <!-- For PDF embed: <embed src="/static/november_rain.pdf" type="application/pdf" width="100%" height="700px" />-->
      </div>
    </div>
  </div>
<!--</div>-->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const player = document.getElementById("video-player");

  console.log("DOM Ready");
  console.log("Queue snapshot from backend:", {{ queue | tojson }});
  console.log("Current song:", "{{ current_song }}");

  window.playSong = function (genre, filename) {
    fetch("/get-next-song", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ genre: genre, filename: filename }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.video && data.sheet) {
          const source = document.getElementById("video-source");
          source.src = data.video;
          player.load(); // reload video source
          player.play(); // optionally auto-play
          document.getElementById("sheet-display").src = data.sheet;
          console.log("playSong called with:", genre, filename);
        }
      });
  };

  window.togglePlayPause = function () {
    if (player.paused) {
      player.play();
    } else {
      player.pause();
    }
  };

  window.stopPlayback = function () {
    player.pause();
    player.currentTime = 0;
  };

  window.restartSong = function () {
    player.currentTime = 0;
    player.play();
  };

  window.clearQueue = function clearQueue() {
    console.log("Clearing Queue");
    fetch("/clear_queue", { method: "POST" }).then(() => location.reload());
  };

  window.addToQueue = function (genre, filename) {
    console.log("Adding to queue:", genre, filename);
    fetch("/add-to-queue", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ genre, filename }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) location.reload();
      });
    console.log("addToQueue called with:", genre, filename);
  };

  window.removeFromQueue = function (filename) {
    console.log("Calling removeFromQueue with:", filename);
    fetch("/remove_from_queue", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ filename: filename }),
    })
      .then((response) => {
        if (response.ok) {
          location.reload();
        } else {
          console.error("Failed to remove from queue");
        }
      });
    console.log("removeFromQueue called with:", filename);
  };

  window.previousSong = function () {
    fetch("/previous", { method: "POST" })
      .then((response) => response.json())
      .then((data) => {
        if (data.video && data.sheet) {
          const source = document.getElementById("video-source");
          source.src = data.video;
          player.load();
          player.play();
          document.getElementById("sheet-display").src = data.sheet;
        }
      });
  };

  window.nextSong = function () {
    fetch("/next", { method: "POST" })
      .then((response) => response.json())
      .then((data) => {
        if (data.video && data.sheet) {
          const source = document.getElementById("video-source");
          source.src = data.video;
          player.load();
          player.play();
          document.getElementById("sheet-display").src = data.sheet;
        }
      });
  };
}); // ‚Üê THIS was previously too early!
</script>




</body>
</html>
